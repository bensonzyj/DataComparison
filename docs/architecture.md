# 业务凭证数据提取比对平台设计

## 1. 系统目标
- 自动解析线下扫描件（图片/PDF/Word）并提取关键业务属性。
- 将提取结果与核心业务系统字段进行比对，输出差异和置信度。
- 支持在线接口调用、可视化展示以及人工复核闭环。

## 2. 总体架构
```
+---------------------+        +--------------------+        +------------------+
|  前端/上传客户端     | -----> |  API 网关 / FastAPI | -----> |  文档处理服务      |
+---------------------+        +--------------------+        |  • 模板管理        |
                                                           |  • OCR/解析策略    |
                                                           +------------------+
                                                                   |
                                                                   v
                                                        +---------------------+
                                                        |  比对引擎服务        |
                                                        |  • 归一化/比对规则   |
                                                        |  • 结果生成          |
                                                        +---------------------+
                                                                   |
                                                                   v
                                                        +---------------------+
                                                        |  结果与配置存储      |
                                                        |  • MySQL/PostgreSQL |
                                                        |  • MinIO/S3         |
                                                        +---------------------+
```

- **API 层**：基于 FastAPI，提供文档上传、比对任务触发、模板管理等接口。
- **文档处理服务**：负责文件预处理、OCR/版面解析（PaddleOCR、pdfplumber、python-docx 等）以及字段抽取。
- **比对引擎**：根据模板配置执行归一化和比对策略，生成字段级差异、置信度和综合结论。
- **存储层**：对象存储保存原件与解析中间结果，关系数据库维护模板、任务状态、比对结果。

## 3. 模块划分
| 模块 | 说明 | 核心技术 |
| ---- | ---- | -------- |
| 文档解析 (Document Parser) | 图片、PDF、Word 文件转结构化文本 | Pillow、pdfplumber、python-docx、pytesseract |
| 字段抽取 (Extraction) | 基于模板的策略化字段提取 | 正则、版式定位、深度模型 |
| 数据比对 (Comparison) | 提供精确、模糊、数值、日期等比对策略 | difflib、Decimal、自定义规则 |
| 模板管理 (Templates) | YAML 配置字段、提取和比对策略 | YAML、热更新 |
| 服务编排 (Service) | 协调解析、抽取、比对，输出报告 | Python 协程/同步流程 |
| API 层 | 对外 REST 接口、健康检查 | FastAPI |

## 4. 数据流
1. 用户上传文档并选择业务模板或自动识别模板。
2. API 将任务入队，文档解析模块根据文件类型选择对应 Parser（OCR、pdfplumber、python-docx 等）。
3. 抽取模块根据模板定义执行字段提取，输出值、置信度、原文片段。
4. 归一化组件对日期、金额等字段做格式统一；比对引擎根据策略与系统数据进行比对，计算得分、差异说明。
5. 结果写入数据库，并返回 API/前端显示，支持人工复核。

## 5. 模板配置示例
```json
{
  "template": {
    "description": "标准承诺书字段模板",
    "fields": [
      {
        "name": "customer_name",
        "extractor": {
          "strategy": "regex",
          "pattern": "姓名[：:]?\\s*(?P<value>[^\\n\\r]+)"
        },
        "comparison": {
          "strategy": "fuzzy",
          "threshold": 0.9
        }
      },
      {
        "name": "amount",
        "extractor": {
          "strategy": "regex",
          "pattern": "金额[：:]?\\s*(?P<value>[0-9,.]+)"
        },
        "comparison": {
          "strategy": "numeric"
        },
        "normalizers": ["numeric"]
      }
    ]
  }
}
```

## 6. 测试与验证
- **单元测试**：覆盖字段提取、归一化、比对策略组合。
- **集成测试**：通过 FastAPI 测试客户端模拟端到端流程。
- **标注集评估**：定期使用人工标注样本计算召回/准确率。

## 7. 运维与扩展
- 使用 Celery/RabbitMQ 处理批量异步任务，避免阻塞上传接口。
- 通过 Prometheus + Grafana 监控处理时延、OCR 准确率、人工复核率。
- 模板版本化管理，支持灰度发布；关键操作写入审计日志。

## 8. 界面建议
- **任务列表**：展示单据编号、比对结果、置信度、更新时间。
- **对比详情**：左侧渲染原件并高亮识别字段，右侧显示系统值、差异说明。
- **复核工作台**：支持批量确认、备注、退回补正。
- **报表仪表盘**：统计通过率、差异类型、处理耗时。

## 9. 技术栈清单
| 层级 | 技术 |
| ---- | ---- |
| 前端 | Vue/React + Ant Design/Element |
| 网关 | Nginx + JWT 鉴权 |
| 后端 | FastAPI + Celery + SQLAlchemy |
| 模型 | PaddleOCR、LayoutLM、DocTR、正则策略 |
| 存储 | PostgreSQL + Redis + MinIO |
| 部署 | Docker/Kubernetes、CI/CD (GitHub Actions/Jenkins) |

